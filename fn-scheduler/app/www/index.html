<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-i18n="app.title">ä»»åŠ¡è®¡åˆ’</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        :root {
            --bg: #ffffff;
            --fg: #0f172a;
            --muted: #6b7280;
            --card: #ffffff;
            --accent: #2563eb;
            /* aliases used by style.css */
            --surface: var(--card);
            --text: var(--fg);
            --border: #e2e8f0;
            --primary: var(--accent);
            --primary-light: #60a5fa;
            --primary-dark: #2563eb;
            --danger: #ef4444;
            --success: #10b981;
            --radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --preview-bg: #0f172a;
            --preview-text: #f8fafc;
        }

        .dark {
            --bg: #0b1220;
            --fg: #e6eef8;
            --muted: #94a3b8;
            --card: #000000;
            --accent: #60a5fa;
            /* aliases for dark theme */
            --surface: var(--card);
            --text: var(--fg);
            --border: #1f2a3a;
            --primary: var(--accent);
            --primary-light: #7fc3ff;
            --primary-dark: #2b6cb0;
            --danger: #fca5a5;
            --success: #34d399;
            --radius: 8px;
            --shadow-sm: none;
            --shadow: none;
            --preview-bg: #0f172a;
            --preview-text: #f8fafc;
        }

        /* selected row highlight colors (light / dark) */
        :root {
            --selected-bg: rgba(224, 242, 254, 0.6);
            --selected-border: rgba(37, 99, 235, 0.9);
        }

        .dark {
            --selected-bg: rgba(96, 165, 250, 0.12);
            --selected-border: rgba(96, 165, 250, 0.9);
        }

        html {
            background: var(--bg);
            color: var(--fg)
        }

        .muted {
            color: var(--muted)
        }

        .btn-theme,
        .lang-select {
            border: 1px solid var(--muted);
            color: var(--fg);
            padding: 6px 8px;
            border-radius: 6px
        }

        .theme-toggle-row {
            display: flex;
            align-items: center;
            gap: 0.5rem
        }
    </style>
</head>

<body>
    <header class="app-header">
        <div>
            <h1 data-i18n="app.title">ä»»åŠ¡è®¡åˆ’</h1>
            <p class="subtitle" data-i18n="app.subtitle">ç®¡ç†å®šæ—¶ä¸æ¡ä»¶è§¦å‘çš„è„šæœ¬ä»»åŠ¡</p>
        </div>
        <div style="display: flex; align-items: center; gap: 1.5em;">
            <a href="https://github.com/RROrg/fn-apps" target="_blank" rel="noopener" id="githubLink"
                class="muted github-link" data-i18n="app.github">GitHub</a>
            <div class="theme-toggle-row">
                <button id="btnTheme" class="btn-theme" data-i18n="btn.theme_toggle" data-i18n-attr="title"
                    title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                <select id="langSelect" class="lang-select" aria-label="è¯­è¨€é€‰æ‹©">
                    <option value="zh-CN">ä¸­æ–‡</option>
                    <option value="en">English</option>
                </select>
            </div>
            <button id="btnRefresh" class="ghost" data-i18n="btn.refresh">åˆ·æ–°</button>
        </div>
    </header>

    <main>
        <section class="toolbar">
            <button id="btnCreate" class="primary" data-i18n="btn.create">æ–°å»º</button>
            <button id="btnEdit" data-i18n="btn.edit">ç¼–è¾‘</button>
            <button id="btnDelete" class="danger" data-i18n="btn.delete">åˆ é™¤</button>
            <button id="btnRun" data-i18n="btn.run">ç«‹å³è¿è¡Œ</button>
            <button id="btnToggle" data-i18n="btn.toggle">å¯ç”¨/åœç”¨</button>
            <button id="btnResults" data-i18n="btn.results">æŸ¥çœ‹ç»“æœ</button>
            <button id="btnManageTemplates" data-i18n="btn.manage_templates">æ¨¡æ¿ç®¡ç†</button>
        </section>

        <section class="table-wrapper">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th data-i18n="table.enabled">æ˜¯å¦å¯åŠ¨</th>
                        <th data-i18n="table.name">ä»»åŠ¡åç§°</th>
                        <th data-i18n="table.next_run">ä¸‹æ¬¡è¿è¡Œæ—¶é—´</th>
                        <th data-i18n="table.trigger">è§¦å‘ç±»å‹</th>
                        <th data-i18n="table.latest_status">æœ€æ–°çŠ¶æ€</th>
                        <th data-i18n="table.account">è´¦å·</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="emptyState" class="empty hidden" data-i18n="empty.no_tasks">æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»â€œæ–°å»ºâ€å¼€å§‹é…ç½®ã€‚</div>
        </section>
    </main>

    <div id="taskModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="taskModalTitle" data-i18n="modal.task.new">æ–°å»ºä»»åŠ¡</h2>
                <button class="ghost" data-close>&times;</button>
            </div>
            <form id="taskForm">
                <input type="hidden" name="task_id" />
                <div class="form-grid">
                    <label>
                        <span data-i18n="field.name">ä»»åŠ¡åç§°</span>
                        <input type="text" name="name" required maxlength="64" />
                    </label>
                    <label>
                        <span data-i18n="field.account">ç”¨æˆ·è´¦å·</span>
                        <div class="account-wrapper">
                            <select name="account" id="accountSelect" required></select>
                            <button type="button" id="btnReloadAccounts" class="ghost small"
                                data-i18n="btn.refresh">åˆ·æ–°</button>
                        </div>
                        <small id="accountStatus" class="muted account-status-text" data-i18n="field.account_hint">Linux
                            ç¯å¢ƒä»…å¯é€‰æ‹©ç³»ç»Ÿç»„çš„è´¦å·ï¼›Windows ç¯å¢ƒé»˜è®¤ä½¿ç”¨å½“å‰ç™»å½•è´¦å·</small>
                    </label>
                    <label>
                        <span data-i18n="field.trigger">è§¦å‘æ–¹å¼</span>
                        <select name="trigger_type" id="triggerType">
                            <option value="schedule" data-i18n="trigger.schedule">å®šæ—¶</option>
                            <option value="event" data-i18n="trigger.event">äº‹ä»¶</option>
                        </select>
                    </label>


                </div>

                <div class="form-section" data-section="schedule">
                    <label>
                        <span data-i18n="field.cron">Cron è¡¨è¾¾å¼</span>
                        <div class="cron-input-wrapper">
                            <input type="text" name="schedule_expression" placeholder="ä¾‹å¦‚ï¼š*/5 * * * *"
                                data-i18n="cron.placeholder" data-i18n-attr="placeholder" />
                            <button type="button" id="btnCronGenerator" class="ghost small"
                                data-i18n="btn.cron_generator">ç”Ÿæˆå™¨</button>
                        </div>
                        <small data-i18n="field.cron_hint">æ ‡å‡† 5 å­—æ®µ Cronï¼Œåˆ†é’Ÿ å°æ—¶ æ—¥ æœˆ å‘¨ï¼ˆå‘¨å­—æ®µ 0=å‘¨ä¸€ï¼‰</small>
                    </label>
                </div>

                <div class="form-section hidden" data-section="event">
                    <label>
                        <span data-i18n="field.event_type">äº‹ä»¶ç±»å‹</span>
                        <select name="event_type" id="eventType">
                            <option value="script" data-i18n="event.script">æ¡ä»¶è„šæœ¬</option>
                            <option value="system_boot" data-i18n="event.system_boot">ç³»ç»Ÿå¼€æœº</option>
                            <option value="system_shutdown" data-i18n="event.system_shutdown">ç³»ç»Ÿå…³æœº</option>
                        </select>
                        <small data-i18n="field.event_hint">ç³»ç»Ÿå¼€/å…³æœºäº‹ä»¶åœ¨æœåŠ¡å¯åŠ¨æˆ–åœæ­¢æ—¶å„è§¦å‘ä¸€æ¬¡</small>
                    </label>
                    <div data-event-subsection="script">
                        <label>
                            <span data-i18n="event.script_note">æ¡ä»¶è„šæœ¬ï¼ˆè¿”å› 0 è§¦å‘ï¼‰</span>
                            <textarea name="condition_script" rows="3"
                                placeholder="#!/bin/bash&#10;test -f /tmp/ready.flag"></textarea>
                        </label>
                        <label>
                            <span data-i18n="event.interval_label">æ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰</span>
                            <input type="number" name="condition_interval" min="10" value="60" />
                        </label>
                    </div>
                </div>

                <label>
                    <span data-i18n="field.pre_tasks">å‰ç½®ä»»åŠ¡</span>
                    <div class="pretask-wrapper">
                        <select name="pre_task_ids" id="preTaskSelect" multiple size="4"></select>
                        <button type="button" id="btnClearPreTasks" class="ghost small"
                            data-i18n="btn.clear_pre_tasks">å…¨å–æ¶ˆ</button>
                    </div>
                    <small data-i18n="field.pre_tasks_hint">ä»…å½“æ‰€é€‰ä»»åŠ¡æœ€è¿‘ä¸€æ¬¡æˆåŠŸåæ‰æ‰§è¡Œ</small>
                </label>

                <!-- æ¨¡æ¿é€‰æ‹© -->
                <label>
                    <span data-i18n="field.template">ä»»åŠ¡æ¨¡æ¿</span>
                    <select name="template" id="templateSelect">
                        <option value="">æ— æ¨¡æ¿ï¼ˆè‡ªå®šä¹‰ï¼‰</option>
                    </select>
                    <small class="muted" data-i18n="field.template_hint">é€‰æ‹©æ¨¡æ¿ä¼šè‡ªåŠ¨å¡«å……ä»»åŠ¡å†…å®¹</small>
                </label>

                <label>
                    <span data-i18n="field.script">ä»»åŠ¡å†…å®¹</span>
                    <textarea name="script_body" rows="6" placeholder="#!/bin/bash&#10;echo hello" required></textarea>
                </label>

                <div class="modal-actions" style="display:flex;align-items:center;gap:0.75rem;">
                    <div style="margin-right:auto;display:flex;align-items:center;gap:0.5rem;">
                        <label style="display:flex;align-items:center;gap:0.5rem;">
                            <span id="isActiveLabel" data-i18n="field.immediate">ç«‹å³å¯åŠ¨</span>
                            <label class="switch" for="isActiveCheckbox">
                                <input type="checkbox" id="isActiveCheckbox" name="is_active" checked
                                    aria-labelledby="isActiveLabel" />
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div>
                        <button type="button" class="ghost" data-close data-i18n="btn.cancel">å–æ¶ˆ</button>
                        <button type="submit" class="primary" data-i18n="btn.save">ä¿å­˜</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="resultModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h2 data-i18n="modal.results.title">æ‰§è¡Œç»“æœ</h2>
                    <p id="resultSubtitle" class="subtitle"></p>
                </div>
                <div class="modal-header-actions">
                    <button id="btnClearResults" class="ghost" data-i18n="btn.clear">æ¸…ç©º</button>
                    <button class="ghost" data-close>&times;</button>
                </div>
            </div>
            <div class="result-list" id="resultList"></div>
        </div>
    </div>

    <!-- æ¨¡æ¿ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="templatesModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h2 data-i18n="modal.templates.title">æ¨¡æ¿ç®¡ç†</h2>
                    <p class="subtitle" data-i18n="modal.templates.subtitle">å¢åŠ ã€ç¼–è¾‘ã€åˆ é™¤æ¨¡æ¿ï¼Œæˆ–å¯¼å…¥/å¯¼å‡ºä¸º JSON</p>
                </div>
                <div class="modal-header-actions">
                    <button class="ghost" data-close>&times;</button>
                </div>
            </div>
            <div style="padding:1rem;">
                <div class="templates-toolbar" style="margin-bottom:0.75rem;">
                    <button id="btnAddTemplate" class="primary" data-i18n="btn.add">æ–°å¢</button>
                    <button id="btnEditTemplate" class="ghost" data-i18n="btn.edit">ç¼–è¾‘</button>
                    <button id="btnDeleteTemplate" class="danger" data-i18n="btn.delete">åˆ é™¤</button>
                    <button id="btnPreviewTemplate" class="ghost" data-i18n="btn.preview">é¢„è§ˆ</button>
                    <input type="file" id="templateImportFile" accept=".json" style="display:none" />
                    <button id="btnImportTemplates" class="ghost" data-i18n="btn.import">å¯¼å…¥ JSON</button>
                    <button id="btnExportTemplates" class="ghost" data-i18n="btn.export">å¯¼å‡º JSON</button>
                </div>
                <div class="templates-table-wrapper">
                    <table id="templatesTable" class="simple-table">
                        <thead>
                            <tr>
                                <th data-i18n="template.col.key">Key</th>
                                <th data-i18n="template.col.name">åç§°</th>
                                <th data-i18n="template.col.preview">é¢„è§ˆï¼ˆé¦–è¡Œï¼‰</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ¿æ–°å¢/ç¼–è¾‘æ¨¡æ€ -->
    <div id="templateEditModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="templateEditTitle" data-i18n="template.edit_title">æ–°å¢æ¨¡æ¿</h2>
                <button class="ghost" data-close>&times;</button>
            </div>
            <form id="templateForm">
                <label>
                    <span data-i18n="template.key_hint">Keyï¼ˆå¯é€‰ï¼Œç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰</span>
                    <input type="text" name="key" maxlength="128" />
                </label>
                <label>
                    <span data-i18n="template.name_label">åç§°</span>
                    <input type="text" name="name" required maxlength="128" />
                </label>
                <label>
                    <span data-i18n="template.script_label">è„šæœ¬å†…å®¹</span>
                    <textarea name="script_body" rows="8" required></textarea>
                </label>
                <div class="modal-actions">
                    <button type="button" class="ghost" data-close data-i18n="btn.cancel">å–æ¶ˆ</button>
                    <button type="submit" class="primary" data-i18n="btn.save">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="templatePreviewModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h2 data-i18n="template.preview_title">æ¨¡æ¿é¢„è§ˆ</h2>
                    <p id="templatePreviewSubtitle" class="subtitle"></p>
                </div>
                <button class="ghost" data-close>&times;</button>
            </div>
            <pre id="templatePreviewContent"
                style="white-space:pre-wrap;padding:16px;border-radius:8px;max-height:60vh;overflow:auto;font-family:JetBrains Mono,Consolas,monospace;font-size:13px;background:var(--preview-bg);color:var(--preview-text)"></pre>
        </div>
    </div>

    <div id="cronModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 data-i18n="cron.generator_title">Cron ç”Ÿæˆå™¨</h2>
                    <p class="subtitle" data-i18n="cron.generator_subtitle">é€šè¿‡é€‰æ‹©å¸¸è§è§„åˆ™å¿«é€Ÿç”Ÿæˆ Cron è¡¨è¾¾å¼</p>
                </div>
                <button class="ghost" data-close>&times;</button>
            </div>
            <form id="cronForm">
                <div class="cron-field-list">
                    <div class="cron-field">
                        <label>
                            <span data-i18n="cron.field.minute">åˆ†é’Ÿ</span>
                            <select data-cron-field="minute">
                                <option value="*" data-i18n="cron.opt.minute.every">æ¯åˆ†é’Ÿ *</option>
                                <option value="0" data-i18n="cron.opt.minute.zero">æ•´ç‚¹ 0</option>
                                <option value="*/5" data-i18n="cron.opt.minute.5">æ¯ 5 åˆ†é’Ÿ */5</option>
                                <option value="*/10" data-i18n="cron.opt.minute.10">æ¯ 10 åˆ†é’Ÿ */10</option>
                                <option value="*/15" data-i18n="cron.opt.minute.15">æ¯ 15 åˆ†é’Ÿ */15</option>
                                <option value="custom" data-i18n="cron.opt.custom">è‡ªå®šä¹‰</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="minute"
                            placeholder="ä¾‹å¦‚ 0,15,30,45" data-i18n-attr="placeholder" />
                    </div>
                    <div class="cron-field">
                        <label>
                            <span data-i18n="cron.field.hour">å°æ—¶</span>
                            <select data-cron-field="hour">
                                <option value="*" data-i18n="cron.opt.hour.every">æ¯å°æ—¶ *</option>
                                <option value="*/2" data-i18n="cron.opt.hour.2">æ¯ 2 å°æ—¶ */2</option>
                                <option value="*/6" data-i18n="cron.opt.hour.6">æ¯ 6 å°æ—¶ */6</option>
                                <option value="*/12" data-i18n="cron.opt.hour.12">æ¯ 12 å°æ—¶ */12</option>
                                <option value="0" data-i18n="cron.opt.hour.midnight">æ¯å¤© 0 ç‚¹</option>
                                <option value="12" data-i18n="cron.opt.hour.noon">æ¯å¤© 12 ç‚¹</option>
                                <option value="custom" data-i18n="cron.opt.custom">è‡ªå®šä¹‰</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="hour"
                            placeholder="ä¾‹å¦‚ 0,6,12,18" data-i18n-attr="placeholder" />
                    </div>
                    <div class="cron-field">
                        <label>
                            <span data-i18n="cron.field.day">æ—¥æœŸï¼ˆå¤©ï¼‰</span>
                            <select data-cron-field="day">
                                <option value="*" data-i18n="cron.opt.day.every">æ¯å¤© *</option>
                                <option value="1" data-i18n="cron.opt.day.1">æ¯æœˆ 1 æ—¥</option>
                                <option value="15" data-i18n="cron.opt.day.15">æ¯æœˆ 15 æ—¥</option>
                                <option value="1-5" data-i18n="cron.opt.day.1_5">æ¯æœˆ 1-5 æ—¥</option>
                                <option value="custom" data-i18n="cron.opt.custom">è‡ªå®šä¹‰</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="day"
                            placeholder="ä¾‹å¦‚ 1-5 æˆ– 1,15" data-i18n-attr="placeholder" />
                    </div>
                    <div class="cron-field">
                        <label>
                            <span data-i18n="cron.field.month">æœˆä»½</span>
                            <select data-cron-field="month">
                                <option value="*" data-i18n="cron.opt.month.every">æ¯æœˆ *</option>
                                <option value="*/3" data-i18n="cron.opt.month.quarter">æ¯å­£åº¦ */3</option>
                                <option value="1" data-i18n="cron.opt.month.jan">1 æœˆ</option>
                                <option value="6" data-i18n="cron.opt.month.jun">6 æœˆ</option>
                                <option value="12" data-i18n="cron.opt.month.dec">12 æœˆ</option>
                                <option value="custom" data-i18n="cron.opt.custom">è‡ªå®šä¹‰</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="month"
                            placeholder="ä¾‹å¦‚ 3,6,9,12" data-i18n-attr="placeholder" />
                    </div>
                    <div class="cron-field">
                        <label>
                            <span data-i18n="cron.field.weekday">æ˜ŸæœŸï¼ˆ0=å‘¨ä¸€ï¼‰</span>
                            <select data-cron-field="weekday">
                                <option value="*" data-i18n="cron.opt.weekday.every">æ¯å‘¨ *</option>
                                <option value="0-4" data-i18n="cron.opt.weekday.workdays">å·¥ä½œæ—¥ 0-4</option>
                                <option value="0" data-i18n="cron.opt.weekday.mon">å‘¨ä¸€ 0</option>
                                <option value="4" data-i18n="cron.opt.weekday.fri">å‘¨äº” 4</option>
                                <option value="5" data-i18n="cron.opt.weekday.sat">å‘¨å…­ 5</option>
                                <option value="6" data-i18n="cron.opt.weekday.sun">å‘¨æ—¥ 6</option>
                                <option value="custom" data-i18n="cron.opt.custom">è‡ªå®šä¹‰</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="weekday"
                            placeholder="ä¾‹å¦‚ 0,2,4" data-i18n-attr="placeholder" />
                    </div>
                </div>
                <div class="cron-preview">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <div>
                            <span data-i18n="cron.current_expression">å½“å‰è¡¨è¾¾å¼ï¼š</span>
                            <code id="cronPreview">* * * * *</code>
                        </div>
                        <div id="cronNextTimes" class="muted" style="font-size:0.95em;text-align:right;min-width:220px">
                        </div>
                    </div>
                </div>
                <small class="muted" data-i18n="cron.hint">é¡ºåºï¼šåˆ†é’Ÿ å°æ—¶ æ—¥ æœˆ å‘¨ï¼›è‡ªå®šä¹‰å­—æ®µå¯ä½¿ç”¨æ•°å­—ã€*ã€/ã€,ã€-ï¼Œä¸ºç©ºæ—¶é»˜è®¤ *</small>
                <div class="modal-actions">
                    <button type="button" class="ghost" data-close data-i18n="btn.cancel">å–æ¶ˆ</button>
                    <button type="button" id="btnApplyCron" class="primary" data-i18n="btn.apply_cron">å¡«å…¥ Cron</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script type="module">
        import translations from './translations.js';

        function t(key, lang) {
            const L = translations[lang] || translations['zh-CN'];
            return L[key] ?? key;
        }

        function applyTranslations(lang) {
            document.documentElement.lang = lang;
            // title
            const docTitle = document.querySelector('title[data-i18n]');
            if (docTitle) { docTitle.textContent = t(docTitle.getAttribute('data-i18n'), lang); }
            // elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!key) return;
                // placeholders or attributes
                const attr = el.getAttribute('data-i18n-attr');
                if (attr) { el.setAttribute(attr, t(key, lang)); }
                else { el.textContent = t(key, lang); }
            });
            // expose a simple global API for other modules
            window.__i18n = window.__i18n || {};
            window.__i18n.lang = lang;
            window.__i18n.translate = (k) => t(k, window.__i18n.lang);
            window.__i18n.setLang = (l) => { localStorage.setItem('lang', l); applyTranslations(l); };
        }

        // Theme handling
        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
            const btn = document.getElementById('btnTheme');
            if (btn) btn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('theme', theme);
        }

        (function init() {
            const savedLang = localStorage.getItem('lang') || navigator.language || 'zh-CN';
            const lang = savedLang.startsWith('en') ? 'en' : 'zh-CN';
            const sel = document.getElementById('langSelect');
            if (sel) sel.value = lang;
            applyTranslations(lang);

            const savedTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);

            // handlers
            document.getElementById('langSelect')?.addEventListener('change', (e) => {
                const v = e.target.value; localStorage.setItem('lang', v); applyTranslations(v);
            });
            document.getElementById('btnTheme')?.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                applyTheme(isDark ? 'light' : 'dark');
            });
        })();

        // å»¶è¿ŸåŠ è½½ä¸»è„šæœ¬ï¼Œç¡®ä¿ç¿»è¯‘ä¸ä¸»é¢˜å…ˆç”Ÿæ•ˆ
        import('./app.js').catch(err => { console.error('Failed to load app.js', err) });
    </script>
</body>

</html>